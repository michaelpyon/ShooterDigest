name: Weekly Digest

on:
  schedule:
    # Every Monday at noon UTC (7am ET / 4am PT)
    - cron: '0 12 * * 1'
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate digest
        run: python main.py

      - name: Update docs/ for GitHub Pages
        run: |
          mkdir -p docs
          cp output/digest_*.html docs/

          # Rebuild index.html with all digests sorted newest-first
          python3 - <<'PYEOF'
          import os, re
          from datetime import datetime

          files = sorted(
              [f for f in os.listdir("docs") if re.match(r"digest_\d{4}-\d{2}-\d{2}\.html", f)],
              reverse=True
          )

          def fmt_date(fname):
              ds = re.search(r"(\d{4}-\d{2}-\d{2})", fname).group(1)
              return datetime.strptime(ds, "%Y-%m-%d").strftime("%B %-d, %Y")

          items = []
          for i, f in enumerate(files):
              badge = ' <span class="badge-new">Latest</span>' if i == 0 else ""
              label = fmt_date(f)
              items.append(
                  f'      <li><a href="{f}"><span class="date">{label}{badge}</span>'
                  f'<span class="arrow">→</span></a></li>'
              )

          list_html = "\n".join(items)

          html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ShooterDigest — Archive</title>
            <style>
              *, *::before, *::after {{ box-sizing: border-box; margin: 0; padding: 0; }}
              body {{ background: #0f0f0f; color: #e8e8e8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height: 100vh; padding: 60px 24px; }}
              .container {{ max-width: 640px; margin: 0 auto; }}
              header {{ margin-bottom: 48px; }}
              h1 {{ font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; color: #ffffff; }}
              h1 span {{ color: #f97316; }}
              .subtitle {{ margin-top: 8px; font-size: 0.9rem; color: #666; }}
              ul {{ list-style: none; }}
              ul li {{ border-bottom: 1px solid #1e1e1e; }}
              ul li:first-child {{ border-top: 1px solid #1e1e1e; }}
              ul li a {{ display: flex; align-items: center; justify-content: space-between; padding: 16px 4px; color: #e8e8e8; text-decoration: none; font-size: 1rem; transition: color 0.15s; }}
              ul li a:hover {{ color: #f97316; }}
              ul li a .date {{ font-weight: 600; }}
              ul li a .arrow {{ color: #444; font-size: 0.85rem; transition: color 0.15s, transform 0.15s; }}
              ul li a:hover .arrow {{ color: #f97316; transform: translateX(4px); }}
              .badge-new {{ font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #f97316; border: 1px solid #f97316; border-radius: 4px; padding: 2px 6px; margin-left: 10px; vertical-align: middle; }}
              footer {{ margin-top: 56px; font-size: 0.78rem; color: #444; }}
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>Shooter<span>Digest</span></h1>
                <p class="subtitle">Weekly competitive FPS briefings — sorted newest first</p>
              </header>
              <ul>
          {list_html}
              </ul>
              <footer>Auto-updated weekly · <a href="https://github.com/michaelpyon/ShooterDigest" style="color:#555;text-decoration:none;">GitHub</a></footer>
            </div>
          </body>
          </html>"""

          with open("docs/index.html", "w") as fh:
              fh.write(html)

          print(f"index.html rebuilt with {len(files)} digests.")
          PYEOF

      - name: Commit and push digest + docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/ docs/
          git diff --cached --quiet || git commit -m "chore: auto-generate weekly digest [skip ci]"
          git push
